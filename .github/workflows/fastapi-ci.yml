name: fastapi-ci.yml

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'k8s/**'

jobs:
  # 1. CI 단계: 코드 품질 및 테스트 검증
  quality_gate_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        # app/requirements.txt의 의존성을 설치합니다.
        run: pip install -r app/requirements.txt

      # 1-1. 린팅 및 정적 분석 (코드 품질 검사)
      - name: Install Linting Tools and Run Checks
        run: |
          pip install flake8
          flake8 app/ --max-complexity=10 --max-line-length=120

  # 2. CD 트리거 단계: 빌드, 푸시 및 Manifest 업데이트
  build_and_update_manifest:
    runs-on: ubuntu-latest
    needs: quality_gate_and_test

    steps:
      - name: Checkout code (for Manifest Update)
        # Git Commit 권한을 위해 PAT_TOKEN을 사용하여 Checkout
        uses: actions/checkout@v4
        with:
          # secrets.PAT_TOKEN을 사용하여 Git Push 권한 획득
          token: ${{ secrets.PAT_TOKEN }}

      # 2-1. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2-2. 이미지 태그 정의 (Git SHA 기반으로 불변 태그 생성)
      - name: Define Docker Tag
        id: tag_info
        run: echo "DOCKER_TAG=${{ secrets.DOCKER_USERNAME }}/fastapi-board:${{ github.sha }}" >> $GITHUB_ENV

      # 2-3. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: ${{ env.DOCKER_TAG }}
          file: ./app/Dockerfile

      # 2-4. ArgoCD Manifest 업데이트
      - name: Update Deployment Image Tag
        uses: mikefarah/yq@v4

      - name: Apply Image Tag Update
        run: |
          yq '.spec.template.spec.containers[0].image = "${{ env.DOCKER_TAG }}"' \
          -i ${{ github.workspace }}/k8s/fastapi-deploy.yml

      - name: Commit and Push Manifest Update
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit -am "CI/CD: Deploying new image ${{ github.sha }}"
          git push
