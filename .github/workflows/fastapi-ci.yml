name: fastapi-ci.yml

on:
  push:
    branches: [ main ]

jobs:
  # 1. CI (ì§€ì†ì  í†µí•©) ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ë° í…ŒìŠ¤íŠ¸ ê²€ì¦
  quality_gate_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        # app/requirements.txtì˜ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
        run: pip install -r app/requirements.txt

      # 1-1. ë¦°íŒ… ë° ì •ì  ë¶„ì„ (ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬)
      - name: Install Linting Tools and Run Checks
        run: |
          pip install flake8
          flake8 app/ --max-complexity=10 --max-line-length=120

  # 2. CD (ì§€ì†ì  ë°°í¬) íŠ¸ë¦¬ê±° ë‹¨ê³„: ë¹Œë“œ, í‘¸ì‹œ ë° Manifest ì—…ë°ì´íŠ¸
  build_and_update_manifest:
    runs-on: ubuntu-latest
    needs: quality_gate_and_test # ğŸ‘ˆ í…ŒìŠ¤íŠ¸ Jobì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰

    steps:
      - name: Checkout code (for Manifest Update)
        # Git Commit ê¶Œí•œì„ ìœ„í•´ PAT_TOKENì„ ì‚¬ìš©í•˜ì—¬ Checkout
        uses: actions/checkout@v4
        with:
          # secrets.PAT_TOKENì„ ì‚¬ìš©í•˜ì—¬ Git Push ê¶Œí•œ íšë“
          token: ${{ secrets.PAT_TOKEN }}

      # 2-1. Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2-2. ì´ë¯¸ì§€ íƒœê·¸ ì •ì˜ (Git SHA ê¸°ë°˜ìœ¼ë¡œ ë¶ˆë³€ íƒœê·¸ ìƒì„±)
      - name: Define Docker Tag
        id: tag_info
        run: echo "DOCKER_TAG=${{ secrets.DOCKER_USERNAME }}/fastapi-board:${{ github.sha }}" >> $GITHUB_ENV

      # 2-3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: ${{ env.DOCKER_TAG }}
          file: ./app/Dockerfile

      # 2-4. ArgoCD Manifest ì—…ë°ì´íŠ¸ (GitOps íŠ¸ë¦¬ê±°ì˜ í•µì‹¬)
      - name: Update Deployment Image Tag
        uses: mikefarah/yq@v4

      - name: Apply Image Tag Update
        run: |
          yq '.spec.template.spec.containers[0].image = "${{ env.DOCKER_TAG }}"' \
          -i ${{ github.workspace }}/k8s/fastapi-deploy.yml

      - name: Commit and Push Manifest Update
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit -am "CI/CD: Deploying new image ${{ github.sha }}"
          git push
